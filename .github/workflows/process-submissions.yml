# When an issue is opened/edited with a job or seeker label (or with a Job URL in the body), create the .md file, push to main, then close the issue.
name: Process issue submissions

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  issues: write

jobs:
  job-from-url:
    runs-on: ubuntu-latest
    # Run when: issue has label job-posting-from-link, OR issue was opened/edited with "### Job URL" section (no label needed)
    if: github.event.label.name == 'job-posting-from-link' || ((github.event.action == 'opened' || github.event.action == 'edited') && contains(github.event.issue.body, '### Job URL'))
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get job URL from issue body
        id: url
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          node -e "
            const body = process.env.ISSUE_BODY || '';
            require('fs').writeFileSync('issue_body.txt', body);
            const match = body.match(/###\s*Job URL\s*\n+([^\n#]+)/);
            let url = match ? match[1].trim() : '';
            if (!url) {
              console.error('No Job URL found in issue body');
              process.exit(1);
            }
            if (!url.startsWith('http')) url = 'https://' + url.replace(/^\/+/, '');
            require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 'url=' + url + '\n');
            console.log('Found URL: ' + url);
          "

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install scrape dependencies
        run: pip install -r scripts/requirements-scrape.txt

      - name: Scrape URL and create job file
        id: scrape
        run: |
          OUTPUT=$(python3 scripts/scrape-job-url.py "${{ steps.url.outputs.url }}")
          OUTPUT=$(echo "$OUTPUT" | tail -1)
          if [ -z "$OUTPUT" ] || [ ! -f "$OUTPUT" ]; then
            echo "Scraper did not produce a job file"
            exit 1
          fi
          echo "path=$OUTPUT" >> "$GITHUB_OUTPUT"
          echo "Created $OUTPUT"

      - name: Regenerate data JSON
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Build jobs and seekers JSON
        run: npm ci && npm run build:jobs

      - name: Commit and push job file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ steps.scrape.outputs.path }}" data/jobs.json data/seekers.json
          git commit -m "chore: add job from issue (quick add) #${{ github.event.issue.number }}"
          git push

      - name: Comment and close issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "Job added from URL. Listing: [View on site](https://jobs.owaspblt.org/jobs.html). This issue will be closed."
          gh issue close ${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  job-form:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'job-posting'
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Write issue body to file
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          node -e "require('fs').writeFileSync('issue_body.txt', process.env.ISSUE_BODY || '')"

      - name: Create job file from form
        id: create
        run: |
          PATH_OUT=$(node scripts/issue-form-to-job.js < issue_body.txt)
          PATH_OUT=$(echo "$PATH_OUT" | tail -1)
          if [ -z "$PATH_OUT" ] || [ ! -f "$PATH_OUT" ]; then
            echo "Form parser did not produce a job file"
            exit 1
          fi
          echo "path=$PATH_OUT" >> "$GITHUB_OUTPUT"
          echo "Created $PATH_OUT"

      - name: Regenerate data JSON
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Build jobs and seekers JSON
        run: npm ci && npm run build:jobs

      - name: Commit and push job file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ steps.create.outputs.path }}" data/jobs.json data/seekers.json
          git commit -m "chore: add job from issue #${{ github.event.issue.number }}"
          git push

      - name: Comment and close issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "Job posting added. [View on site](https://jobs.owaspblt.org/jobs.html). This issue will be closed."
          gh issue close ${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  seeker:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'job-seeker'
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Write issue body to file
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          node -e "require('fs').writeFileSync('issue_body.txt', process.env.ISSUE_BODY || '')"

      - name: Create seeker file from form
        id: create
        run: |
          PATH_OUT=$(node scripts/issue-form-to-seeker.js < issue_body.txt)
          PATH_OUT=$(echo "$PATH_OUT" | tail -1)
          if [ -z "$PATH_OUT" ] || [ ! -f "$PATH_OUT" ]; then
            echo "Form parser did not produce a seeker file"
            exit 1
          fi
          echo "path=$PATH_OUT" >> "$GITHUB_OUTPUT"
          echo "Created $PATH_OUT"

      - name: Regenerate data JSON
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Build jobs and seekers JSON
        run: npm ci && npm run build:jobs

      - name: Commit and push seeker file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ steps.create.outputs.path }}" data/jobs.json data/seekers.json
          git commit -m "chore: add seeker profile from issue #${{ github.event.issue.number }}"
          git push

      - name: Comment and close issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "Profile added. [View on site](https://jobs.owaspblt.org/seekers.html). This issue will be closed."
          gh issue close ${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
