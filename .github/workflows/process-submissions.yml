# When an issue is opened with a job or seeker label, create the .md file, push to main, then close the issue.
name: Process issue submissions

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  job-from-url:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'job-posting-from-link'
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get job URL from issue body
        id: url
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          node -e "require('fs').writeFileSync('issue_body.txt', process.env.ISSUE_BODY || '')"
          URL=$(grep -oE 'https?://[^ \t\n\r]+' issue_body.txt | head -1)
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          if [ -z "$URL" ]; then
            echo "No URL found in issue body"
            exit 1
          fi
          echo "Found URL: $URL"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install scrape dependencies
        run: pip install -r scripts/requirements-scrape.txt

      - name: Scrape URL and create job file
        id: scrape
        run: |
          OUTPUT=$(python3 scripts/scrape-job-url.py "${{ steps.url.outputs.url }}")
          echo "path=$OUTPUT" >> "$GITHUB_OUTPUT"
          echo "Created $OUTPUT"

      - name: Commit and push job file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ steps.scrape.outputs.path }}"
          git commit -m "chore: add job from issue (quick add) #${{ github.event.issue.number }}"
          git push

      - name: Comment and close issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "Job added from URL. Listing: [View on site](https://pritz395.github.io/BLT-Jobs/jobs.html). This issue will be closed."
          gh issue close ${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  job-form:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'job-posting'
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Write issue body to file
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          node -e "require('fs').writeFileSync('issue_body.txt', process.env.ISSUE_BODY || '')"

      - name: Create job file from form
        id: create
        run: |
          PATH_OUT=$(node scripts/issue-form-to-job.js < issue_body.txt)
          echo "path=$PATH_OUT" >> "$GITHUB_OUTPUT"
          echo "Created $PATH_OUT"

      - name: Commit and push job file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ steps.create.outputs.path }}"
          git commit -m "chore: add job from issue #${{ github.event.issue.number }}"
          git push

      - name: Comment and close issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "Job posting added. [View on site](https://pritz395.github.io/BLT-Jobs/jobs.html). This issue will be closed."
          gh issue close ${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  seeker:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'job-seeker'
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Write issue body to file
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          node -e "require('fs').writeFileSync('issue_body.txt', process.env.ISSUE_BODY || '')"

      - name: Create seeker file from form
        id: create
        run: |
          PATH_OUT=$(node scripts/issue-form-to-seeker.js < issue_body.txt)
          echo "path=$PATH_OUT" >> "$GITHUB_OUTPUT"
          echo "Created $PATH_OUT"

      - name: Commit and push seeker file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ steps.create.outputs.path }}"
          git commit -m "chore: add seeker profile from issue #${{ github.event.issue.number }}"
          git push

      - name: Comment and close issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "Profile added. [View on site](https://pritz395.github.io/BLT-Jobs/seekers.html). This issue will be closed."
          gh issue close ${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
